{{define "base"}}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}MonitorGo{{end}}</title>
    {{if .CSRFToken}}
    <meta name="csrf-token" content="{{.CSRFToken}}">
    {{end}}
    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Restore Accent Color immediately
        const savedAccent = localStorage.getItem('accent-color');
        if (savedAccent) {
            document.documentElement.style.setProperty('--primary-color', savedAccent);
            document.documentElement.style.setProperty('--primary-hover', savedAccent);
        }
    </script>
    <link rel="stylesheet" href="/static/css/style.css?v=14">
</head>

<body>
    <!-- Skip Link (Accessibilite) -->
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>

    <!-- Overlay Mobile -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="brand">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="brand-icon">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                    <span>Monitor<span class="brand-highlight">Go</span></span>
                </a>
            </div>

            <nav class="sidebar-nav" role="navigation" aria-label="Navigation principale">
                <a href="/" class="nav-item" data-page="/">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="/alerts" class="nav-item" data-page="/alerts">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span>Alertes</span>
                </a>
                <a href="/settings" class="nav-item" data-page="/settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                    <span>Parametres</span>
                </a>
                {{if eq .Role "admin"}}
                <div class="nav-divider"></div>
                <span class="nav-section-label">Administration</span>
                <a href="/users" class="nav-item" data-page="/users">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Utilisateurs</span>
                </a>
                <a href="/audit" class="nav-item" data-page="/audit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>Audit</span>
                </a>
                {{end}}
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">{{if .Username}}{{slice .Username 0 1 | upper}}{{else}}U{{end}}</div>
                    <div class="user-info">
                        <span class="user-name">{{if .Username}}{{.Username}}{{else}}Utilisateur{{end}}</span>
                        <span class="user-role">{{if eq .Role "admin"}}Administrateur{{else}}Lecteur{{end}}</span>
                    </div>
                </div>
                <form action="/logout" method="post">
                    <button type="submit" class="btn-logout" title="Deconnexion">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <header class="top-bar">
                <!-- Hamburger Menu (Mobile) -->
                <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Ouvrir le menu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="search-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="machine-search" placeholder="Rechercher une machine..."
                        onkeyup="filterMachines()" aria-label="Rechercher une machine">
                </div>
                <div class="top-actions">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Changer le theme"
                        aria-label="Basculer entre theme clair et sombre">
                        <!-- Sun Icon (Light Mode) -->
                        <svg class="theme-icon light-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <!-- Moon Icon (Dark Mode) -->
                        <svg class="theme-icon dark-icon hidden" xmlns="http://www.w3.org/2000/svg" width="20"
                            height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    {{if .Status}}
                    <div class="status-badge status-{{.Status | lower}}" title="Statut global de l'infrastructure">
                        <span class="status-dot-mini"></span>
                        {{.Status}}
                    </div>
                    {{end}}
                    <button class="btn btn-primary btn-sm" onclick="openAddModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Machine
                    </button>
                </div>
            </header>

            <div class="content-wrapper page-content">
                {{block "content" .}}{{end}}
            </div>
        </main>
    </div>

    <!-- Global Modals -->
    <!-- Modal Ajouter Machine -->
    <div id="add-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="add-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="add-modal-title">Ajouter une machine</h2>
                <button class="modal-close" onclick="closeAddModal()" aria-label="Fermer">&times;</button>
            </div>
            <form id="add-machine-form" onsubmit="addMachine(event)">
                <div class="form-group">
                    <label for="machine-id">ID (unique)</label>
                    <input type="text" id="machine-id" name="id" required placeholder="srv-web-01">
                </div>
                <div class="form-group">
                    <label for="machine-name">Nom</label>
                    <input type="text" id="machine-name" name="name" required placeholder="Serveur Web Principal">
                </div>
                <div class="form-group">
                    <label for="machine-group">Groupe</label>
                    <input type="text" id="machine-group" name="group" placeholder="Serveurs Web">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="machine-host">Hote / IP</label>
                        <input type="text" id="machine-host" name="host" required placeholder="192.168.1.10">
                    </div>
                    <div class="form-group form-group-small">
                        <label for="machine-port">Port</label>
                        <input type="number" id="machine-port" name="port" value="22" min="1" max="65535">
                    </div>
                </div>
                <div class="form-group">
                    <label for="machine-user">Utilisateur SSH</label>
                    <input type="text" id="machine-user" name="user" required placeholder="monitoring">
                </div>
                <div class="form-group">
                    <label>Authentification</label>
                    <div class="auth-tabs">
                        <button type="button" class="auth-tab active" onclick="switchAuthTab('key')">Cle SSH</button>
                        <button type="button" class="auth-tab" onclick="switchAuthTab('password')">Mot de passe</button>
                    </div>
                </div>
                <div id="auth-key" class="form-group">
                    <label for="machine-keypath">Chemin de la cle privee</label>
                    <input type="text" id="machine-keypath" name="key_path" placeholder="/home/user/.ssh/id_rsa">
                </div>
                <div id="auth-password" class="form-group" style="display: none;">
                    <label for="machine-password">Mot de passe</label>
                    <input type="password" id="machine-password" name="password">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifier Machine -->
    <div id="edit-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="edit-modal-title">Modifier la machine</h2>
                <button class="modal-close" onclick="closeEditModal()" aria-label="Fermer">&times;</button>
            </div>
            <form id="edit-machine-form" onsubmit="updateMachine(event)">
                <div class="form-group">
                    <label for="edit-machine-id">ID (Non modifiable)</label>
                    <input type="text" id="edit-machine-id" name="id" readonly class="input-disabled">
                </div>
                <div class="form-group">
                    <label for="edit-machine-name">Nom</label>
                    <input type="text" id="edit-machine-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="edit-machine-group">Groupe</label>
                    <input type="text" id="edit-machine-group" name="group">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-machine-host">Hote / IP</label>
                        <input type="text" id="edit-machine-host" name="host" required>
                    </div>
                    <div class="form-group form-group-small">
                        <label for="edit-machine-port">Port</label>
                        <input type="number" id="edit-machine-port" name="port" min="1" max="65535">
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-machine-user">Utilisateur SSH</label>
                    <input type="text" id="edit-machine-user" name="user" required>
                </div>
                <div class="form-group">
                    <label>Authentification (Laisser vide pour ne pas changer)</label>
                    <div class="auth-tabs">
                        <button type="button" class="auth-tab active" onclick="switchEditAuthTab('key')">Cle SSH</button>
                        <button type="button" class="auth-tab" onclick="switchEditAuthTab('password')">Mot de passe</button>
                    </div>
                </div>
                <div id="edit-auth-key" class="form-group">
                    <label for="edit-machine-keypath">Chemin de la cle privee</label>
                    <input type="text" id="edit-machine-keypath" name="key_path">
                </div>
                <div id="edit-auth-password" class="form-group" style="display: none;">
                    <label for="edit-machine-password">Mot de passe</label>
                    <input type="password" id="edit-machine-password" name="password">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Confirmation Suppression -->
    <div id="delete-modal" class="modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-title" aria-describedby="delete-modal-desc">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="delete-modal-title">Confirmer la suppression</h2>
                <button class="modal-close" onclick="closeDeleteModal()" aria-label="Fermer">&times;</button>
            </div>
            <p id="delete-modal-desc">Etes-vous sur de vouloir supprimer la machine <strong id="delete-machine-name"></strong> ?</p>
            <p class="warning-text">Cette action est irreversible.</p>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container" aria-live="polite"></div>

    <script>
        // === Sidebar Toggle (Mobile) ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        // Close sidebar on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
                // Close any open modal
                document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));
            }
        });

        // === Theme Toggle ===
        function toggleTheme() {
            const html = document.documentElement;
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');

            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
        }

        // === Toast System ===
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                error: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                warning: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Fermer">&times;</button>
                <div class="toast-progress" style="animation-duration: ${duration}ms"></div>
            `;

            container.appendChild(toast);

            // Trigger entrance animation
            requestAnimationFrame(() => toast.classList.add('toast-visible'));

            // Auto-remove
            setTimeout(() => {
                toast.classList.remove('toast-visible');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // === Init ===
        document.addEventListener('DOMContentLoaded', () => {
            // Init theme icon state
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            if (isDark) {
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            } else {
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }

            // Highlight active sidebar navigation
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-item').forEach(link => {
                const page = link.getAttribute('data-page') || link.getAttribute('href');
                if (page === currentPath || (page === '/' && currentPath === '/')) {
                    link.classList.add('active');
                } else if (currentPath.startsWith('/machine/') && page === '/') {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
    <script src="/static/js/csrf.js"></script>
    <script src="/static/js/dialog.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/machines.js"></script>
    {{block "scripts" .}}{{end}}
</body>

</html>
{{end}}
