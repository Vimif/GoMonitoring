{{define "title"}}Parametres - MonitorGo{{end}}

{{define "content"}}
<div class="page-header">
    <div class="header-content">
        <div class="header-title-row">
            <div class="title-left">
                <h1>Parametres</h1>
                <span class="header-subtitle">Configurez votre experience MonitorGo</span>
            </div>
        </div>
    </div>
</div>

<div class="settings-grid">

    <!-- Appearance Card -->
    <div class="card settings-card">
        <div class="card-header">
            <div class="card-header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </div>
            <h3>Apparence</h3>
        </div>
        <div class="card-body settings-body">
            <div class="settings-option">
                <label class="settings-label">Theme</label>
                <div class="auth-tabs theme-switcher">
                    <button type="button" class="auth-tab active" onclick="setTheme('light')"
                        id="btn-theme-light">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle></svg>
                        Clair
                    </button>
                    <button type="button" class="auth-tab" onclick="setTheme('dark')"
                        id="btn-theme-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        Sombre
                    </button>
                    <button type="button" class="auth-tab" onclick="setTheme('system')"
                        id="btn-theme-system">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                        Systeme
                    </button>
                </div>
            </div>

            <div class="settings-option">
                <label class="settings-label">Couleur d'accentuation</label>
                <div class="color-options">
                    <button class="color-btn blue active" onclick="setAccentColor('#3b82f6')" title="Bleu"></button>
                    <button class="color-btn purple" onclick="setAccentColor('#8b5cf6')" title="Violet"></button>
                    <button class="color-btn emerald" onclick="setAccentColor('#10b981')" title="Emeraude"></button>
                    <button class="color-btn orange" onclick="setAccentColor('#f97316')" title="Orange"></button>
                    <button class="color-btn rose" onclick="setAccentColor('#f43f5e')" title="Rose"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Card -->
    <div class="card settings-card">
        <div class="card-header">
            <div class="card-header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
            <h3>Securite</h3>
        </div>
        <div class="card-body settings-body">
            <form id="pwd-form" onsubmit="updatePassword(event)">
                <div class="form-group">
                    <label for="current-password">Mot de passe actuel</label>
                    <input type="password" id="current-password" name="current_password" class="form-control" required
                        autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="new-password">Nouveau mot de passe</label>
                    <input type="password" id="new-password" name="new_password" class="form-control" required minlength="8"
                        autocomplete="new-password">
                    <p class="help-text">Minimum 8 caracteres</p>
                </div>
                <div class="form-actions go-right">
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Mettre a jour
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- About Card -->
    <div class="card settings-card">
        <div class="card-header">
            <div class="card-header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            </div>
            <h3>A propos</h3>
        </div>
        <div class="card-body settings-body">
            <div class="about-grid">
                <div class="about-item">
                    <span class="about-label">Version</span>
                    <span class="about-value">3.0.0</span>
                </div>
                <div class="about-item">
                    <span class="about-label">Moteur</span>
                    <span class="about-value">Go + HTML/CSS/JS</span>
                </div>
                <div class="about-item">
                    <span class="about-label">Base de donnees</span>
                    <span class="about-value">SQLite3</span>
                </div>
                <div class="about-item">
                    <span class="about-label">Protocole</span>
                    <span class="about-value">SSH / WebSocket</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Theme & Accent Logic
    function setTheme(mode) {
        if (mode === 'system') {
            localStorage.removeItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
            localStorage.setItem('theme', mode);
            document.documentElement.setAttribute('data-theme', mode);
        }
        updateThemeButtons(mode);
    }

    function updateThemeButtons(mode) {
        document.querySelectorAll('.theme-switcher .auth-tab').forEach(btn => btn.classList.remove('active'));
        const btn = document.getElementById('btn-theme-' + mode);
        if (btn) btn.classList.add('active');
    }

    function setAccentColor(color) {
        document.documentElement.style.setProperty('--primary-color', color);
        document.documentElement.style.setProperty('--primary-hover', color);
        localStorage.setItem('accent-color', color);

        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
        const matchedBtn = Array.from(document.querySelectorAll('.color-btn')).find(b => b.onclick.toString().includes(color));
        if (matchedBtn) matchedBtn.classList.add('active');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'system';
        updateThemeButtons(savedTheme);

        const savedAccent = localStorage.getItem('accent-color');
        if (savedAccent) {
            setAccentColor(savedAccent);
        }
    });

    async function updatePassword(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/api/profile/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            if (typeof showToast === 'function') {
                showToast('Mot de passe mis a jour avec succes', 'success');
            } else {
                await dialog.alert('Mot de passe mis a jour avec succes', {
                    title: 'Succes',
                    type: 'success'
                });
            }
            e.target.reset();
        } catch (err) {
            if (typeof showToast === 'function') {
                showToast(err.message, 'error');
            } else {
                await dialog.alert(err.message, {
                    title: 'Erreur',
                    type: 'error'
                });
            }
        }
    }
</script>
{{end}}
